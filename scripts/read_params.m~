function params = read_params(paramfile)
%READ_EIJ reads a binary file of parameters for a pairwise maximum entropy
%  model (undirected graphical model) estimated by plm. The model describes
%  the distribution of sequences of length L drawn from an alphabet with q
%  characters. The outputs are:
%   
%   Object      Description                         Type Dimensions
%   hi          sitewise fields     hi(i,Ai)        L x q
%   Jij         pairwise couplings  Jij(i,j,Ai,Aj)  L x L x q x q
%   fi          sitewise marginals  fi(i,Ai)        L x q
%   fij         pairwise marginals  fij(i,j,Ai,Aj)  L x L x q x q
%
%   Note that both the eij and fij arrays are output in dense form, but 
%   will be symmetric under (i,j,ai,aj) <-> (j,i,aj,ai)
%

PRECISION = 'single';

f_params = fopen(paramfile, 'r');
% Alignment dimensions
% 1: Number of sites
L = fread(f_params, 1, 'int');
% 1: Number of codes in alphabet
q = fread(f_params, 1, 'int');
% 1: Number of valid sequences in alignment
params.numSeqs = fread(f_params, 1, 'int');
% 1: Number of invalid sequences in alignment
params.numInvalidSeqs = fread(f_params, 1, 'int');
% 1: Number of invalid sequences in alignment
params.numIter = fread(f_params, 1, 'int');
% 1: Number of invalid sequences in alignment
params.theta = fread(f_params, 1, PRECISION);
% 1: Number of invalid sequences in alignment
params.lambda_h = fread(f_params, 1, PRECISION);
% 1: Number of invalid sequences in alignment
params.lambda_J = fread(f_params, 1, PRECISION);
% 1: Number of invalid sequences in alignment
params.lambda_group = fread(f_params, 1, PRECISION);
% 1: Number of invalid sequences in alignment
params.nEff = fread(f_params, 1, PRECISION)';
% 1: Number of invalid sequences in alignment
params.alphabet = char(fread(f_params, q, 'char'));
params.weights = fread(f_params, params.numSeqs + params.numInvalidSeqs, PRECISION);
params.target_seq = char(fread(f_params, L, 'char'))';
params.offset_map = fread(f_params, L, 'int');
% Single-site marginals
params.fi = fread(f_params, [q L], PRECISION)';
% Single-site biases
params.hi = fread(f_params, [q L], PRECISION)';
params.Jij = zeros(L, L, q, q);

% Read largest block containing couplings and pair marginals
block = fread(f_params, L*(L-1)*q*q, PRECISION);
params.fij = zeros(L, L, q, q);
offset = 0;
for i=1:(L-1)
    for j=(i+1):L
        params.fij(j,i,:,:) = reshape(block(offset + [1:q*q]), [q q]);
        params.fij(i,j,:,:) = reshape(block(offset + [1:q*q]), [q q])';
        offset = offset + 2*q*q;
    end
end
params.Jij = zeros(L, L, q, q);
offset = 0;
for i=1:(L-1)
    for j=(i+1):L
        params.Jij(j,i,:,:) = reshape(block(offset + q*q + [1:q*q]), [q q]);
        params.Jij(i,j,:,:) = reshape(block(offset + q*q + [1:q*q]), [q q])';
        offset = offset + 2*q*q;
    end
end

fclose(f_params);
end